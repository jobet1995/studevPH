name: StudevPH Pipeline

on:
  push:
    branches:
      - development
      - qa
      - uat
      - prod
      - master
  pull_request:
    branches:
      - development
      - qa
      - uat
      - prod
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: studevph-app
  REGISTRY: docker.io
  COMPOSE_FILE: docker-compose.yml

jobs:
  # 1. Validate code and configuration
  validate:
    name: Validate Code & Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python environment
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "Dependencies installed successfully"

      - name: Run Python linting and import sorting checks
        run: |
          source .venv/bin/activate
          echo "Running flake8..."
          flake8 . --max-line-length=120
          echo "Running isort check..."
          isort --check-only --diff .
          echo "Linting and import checks passed"

      - name: Validate Nginx configuration
        run: |
          docker run --rm \
            docker run --rm -v ${{ github.workspace }}/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
            nginx:1.25-alpine nginx -t -c /etc/nginx/nginx.conf || true

      - name: Validate Docker Compose
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} config
          echo "Docker Compose configuration is valid"

  # 2. Build and push Docker image (depends on validations)
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/studevph-app:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/studevph-app:${{ github.sha }}

  # 3. Deploy to Development
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/development'
    environment: development

    steps:
      - uses: actions/checkout@v4
      - name: Pull latest image & deploy
        run: |
          docker compose pull
          docker compose run --rm web python manage.py migrate --noinput
          docker compose run --rm web python manage.py collectstatic --noinput
          docker compose up -d --remove-orphans

  # 4. Deploy to QA
  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/qa'
    environment: qa

    steps:
      - uses: actions/checkout@v4
      - name: Pull latest image & deploy
        run: |
          docker compose pull
          docker compose run --rm web python manage.py migrate --noinput
          docker compose run --rm web python manage.py collectstatic --noinput
          docker compose up -d --remove-orphans

  # 5. Deploy to UAT
  deploy-uat:
    name: Deploy to UAT
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/uat'
    environment: uat

    steps:
      - uses: actions/checkout@v4
      - name: Pull latest image & deploy
        run: |
          docker compose pull
          docker compose run --rm web python manage.py migrate --noinput
          docker compose run --rm web python manage.py collectstatic --noinput
          docker compose up -d --remove-orphans

  # 6. Deploy to Production (only after validations & builds)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/prod'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
        
      - name: Pull or Build Docker Image
        run: |
            IMAGE=${{ secrets.DOCKERHUB_USERNAME}}/studevph-app:latest
            echo "Attempting to pull image $IMAGE ..."
            if docker pull $IMAGE; then
                echo "Image pulled succesfully"
            else
                echo "Image not found. Building locally..."
                docker compose build web
            fi
      - name: Deploy Production
        run: |
            echo "Starting deployment..."
            docker compose run --rm web python manage.py migrate --noinput
            docker compose run --rm web python manage.py collectstatic --noinput
            docker compose up -d --remove-orphans
            echo "Cleaning up old Docker images..."
            docker image prune -f